<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Modern Chat App</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://js.pusher.com/8.4.0/pusher.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="max-w-xl mx-auto mt-10 p-4 bg-white shadow rounded">
    <h2 class="text-2xl font-bold mb-4">üó®Ô∏è Chat App</h2>

    <div id="auth" class="mb-4">
      <input id="email" type="email" placeholder="Email" class="border p-2 w-full mb-2" />
      <input id="password" type="password" placeholder="Password" class="border p-2 w-full mb-2" />
      <button onclick="login()" class="bg-blue-500 text-white px-4 py-2 rounded w-full">Login</button>
    </div>

    <div id="chat-ui" class="hidden">
      <div id="chat" class="border p-2 h-64 overflow-y-scroll mb-2 bg-gray-50 rounded"></div>
      <input id="message" type="text" placeholder="Type a message..." class="border p-2 w-full mb-2" />
      <button onclick="sendMessage()" class="bg-green-500 text-white px-4 py-2 rounded w-full">Send</button>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://igdozfkfjvlmetaamtkf.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlnZG96ZmtmanZsbWV0YWFtdGtmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE4MTE2ODEsImV4cCI6MjA3NzM4NzY4MX0.0efyAEWPKGb__ofiHWT9ZHZv6vPYqRTa4FxyRBsJg6g";
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentUser = null;

    async function login() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) return alert("Login failed: " + error.message);
      currentUser = data.user;
      document.getElementById("auth").classList.add("hidden");
      document.getElementById("chat-ui").classList.remove("hidden");
      loadMessages();
    }

    async function loadMessages() {
      const { data, error } = await supabase.from("messages").select("*").order("timestamp", { ascending: true });
      if (error) return console.error(error);
      data.forEach(msg => displayMessage(msg.username, msg.message, msg.timestamp));
    }

    function displayMessage(user, message, timestamp) {
      const chat = document.getElementById("chat");
      const msg = document.createElement("div");
      msg.className = "mb-1";
      msg.innerHTML = `<strong>${user}</strong>: ${message} <span class="text-xs text-gray-500">(${new Date(timestamp).toLocaleTimeString()})</span>`;
      chat.appendChild(msg);
      chat.scrollTop = chat.scrollHeight;
    }

    async function sendMessage() {
      const message = document.getElementById("message").value;
      if (!message) return;
      const { error } = await supabase.from("messages").insert([
        { username: currentUser.email, message }
      ]);
      if (error) return console.error(error);
      document.getElementById("message").value = "";
    }

    // Pusher setup
    const pusher = new Pusher("6e3435d4a0677bd5dda3", { cluster: "us2" });
    const channel = pusher.subscribe("chat-channel");
    channel.bind("new-message", function (data) {
      displayMessage(data.username, data.message, data.timestamp);
    });

    // Supabase realtime listener (optional alternative to Pusher)
    supabase
      .channel("realtime-messages")
      .on("postgres_changes", { event: "INSERT", schema: "public", table: "messages" }, payload => {
        const msg = payload.new;
        displayMessage(msg.username, msg.message, msg.timestamp);
      })
      .subscribe();
  </script>
</body>
</html>
